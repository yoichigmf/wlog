# コンテンツフォルダアクセスエラーのトラブルシューティング

## エラー概要

```
I/flutter: フォルダにアップロード: 1u9KIeryxLcRZjirimFYF8BRBnUFIjZW9
I/flutter: ファイルアップロードエラー: DetailedApiRequestError(status: 404, message: File not found: 1u9KIeryxLcRZjirimFYF8BRBnUFIjZW9.)
I/flutter: Drive APIにアクセスできないため、以降のファイルアップロードをスキップします
I/flutter: テキストデータのみアップロードを続行します
```

このエラーは、コンテンツフォルダIDで指定されたGoogle Driveフォルダにアクセスできない場合に発生します。

## 原因と対処法

### 1. フォルダIDが間違っている

**確認方法:**
1. Google Driveでフォルダを開く
2. URLからフォルダIDを確認:
   ```
   https://drive.google.com/drive/folders/[フォルダID]
   ```
3. マスタースプレッドシートの「コンテンツフォルダ」列のIDと一致しているか確認

**対処:**
- 正しいフォルダIDをマスタースプレッドシートに入力
- アプリで設定を再選択

### 2. フォルダへのアクセス権限がない

**問題:**
サインインしているGoogleアカウント（例: `yoichi.kayama@gmail.com`）がそのフォルダにアクセスできない

**確認方法:**
1. Google Driveでフォルダを開けるか確認
2. アプリでサインインしているアカウントと同じアカウントでブラウザにサインイン
3. そのアカウントでフォルダにアクセスできるか確認

**対処:**
- フォルダの共有設定で、使用しているGoogleアカウントに**編集者**権限を付与
- または、フォルダのオーナーに権限付与を依頼

### 3. 組織のワークスペースで制限されている

**状況:**
- フォルダが組織のGoogle Workspaceにある
- ゲストアカウントでアクセスしようとしている
- 組織のポリシーで外部アプリからのアクセスが制限されている

**対処法:**

#### オプション1: 個人のGoogleドライブにフォルダを作成
1. 個人のGoogleアカウントで新しいフォルダを作成
2. そのフォルダIDをマスタースプレッドシートに設定
3. アプリで設定を再選択

#### オプション2: 組織管理者に相談
1. Google Workspace管理者に連絡
2. Drive APIへのアクセス許可を依頼
3. または、特定のOAuth 2.0クライアントIDを許可リストに追加してもらう

#### オプション3: コンテンツフォルダIDを設定しない
1. マスタースプレッドシートの「コンテンツフォルダ」列を空欄にする
2. アプリで設定を再選択
3. Spreadsheetの親フォルダ内の`files`サブフォルダにアップロードされる（従来通り）

### 4. フォルダが削除されている

**確認方法:**
- Google Driveでフォルダが存在するか確認
- ゴミ箱にないか確認

**対処:**
- フォルダを復元
- または、新しいフォルダを作成してマスタースプレッドシートを更新

### 5. 共有ドライブ（Shared Drive）へのアクセス

**問題:**
共有ドライブのフォルダにアクセスできない

**現在の対応状況:**
- ✅ `supportsAllDrives: true` パラメータを追加済み
- ✅ 共有ドライブもサポートされています

**それでもアクセスできない場合:**
1. 共有ドライブのメンバーになっているか確認
2. 「コンテンツ管理者」以上の権限があるか確認
3. 組織のポリシーで共有ドライブへの外部アプリアクセスが許可されているか確認

## エラー時の動作

### アプリの動作

コンテンツフォルダにアクセスできない場合、アプリは以下のように動作します：

1. **フォルダアクセス確認（事前チェック）**
   ```
   I/flutter: フォルダ確認中: 1u9KIeryxLcRZjirimFYF8BRBnUFIjZW9
   I/flutter: フォルダ確認エラー: ...
   ```

2. **エラーメッセージ表示**
   ```
   警告: コンテンツフォルダアクセスエラー
   コンテンツフォルダにアクセスできません（ID: 1u9KIeryxLcRZjirimFYF8BRBnUFIjZW9）

   以下を確認してください：
   1. フォルダIDが正しいか
   2. このGoogleアカウント（yoichi.kayama@gmail.com等）がフォルダにアクセスできるか
   3. フォルダが削除されていないか

   ※ テキストデータのみアップロードを続行します
   ```

3. **テキストデータのみアップロード**
   - メディアファイル（画像、音声、動画）はアップロードされません
   - テキスト情報（登録日時、テキストコンテンツ、緯度・経度など）は正常にアップロードされます
   - ファイルURL列は空欄になります

## 推奨される設定

### 個人利用の場合

1. **個人のGoogleアカウントを使用**
   - 組織のポリシーの影響を受けない
   - シンプルな設定で動作

2. **フォルダを個人のGoogleドライブに作成**
   ```
   マイドライブ/
     └── flog-content/  ← このフォルダIDを使用
   ```

### 組織で利用する場合

1. **アクセス可能なフォルダを使用**
   - 自分が作成したフォルダ
   - または、編集者権限を持っているフォルダ

2. **フォルダの共有設定を確認**
   - 使用するGoogleアカウントに**編集者**権限があるか確認
   - 「閲覧者」や「コメント可」では書き込みができません

3. **組織管理者と相談**
   - 外部アプリのアクセスポリシーを確認
   - 必要に応じてOAuth 2.0クライアントIDを許可リストに追加

## デバッグ手順

### ステップ1: フォルダIDの確認

```bash
# マスタースプレッドシートからコンテンツフォルダIDを確認
1u9KIeryxLcRZjirimFYF8BRBnUFIjZW9
```

### ステップ2: ブラウザでアクセステスト

1. アプリと同じGoogleアカウントでブラウザにサインイン
2. 以下のURLを開く:
   ```
   https://drive.google.com/drive/folders/1u9KIeryxLcRZjirimFYF8BRBnUFIjZW9
   ```
3. フォルダが開けるか、ファイルをアップロードできるか確認

### ステップ3: アプリログの確認

```bash
flutter run --verbose
```

ログで以下を確認：
- `認証ユーザー: [メールアドレス]` - どのアカウントでサインインしているか
- `フォルダ確認中: [フォルダID]` - アクセスしようとしているフォルダ
- `フォルダ確認エラー: ...` - エラーの詳細

### ステップ4: 権限の確認

Google Driveのフォルダで「共有」→「権限の管理」を開き：
- アプリで使用しているアカウントが含まれているか
- 権限が「編集者」になっているか

## 回避策

### 一時的な回避策

**コンテンツフォルダIDを削除:**
1. マスタースプレッドシートの「コンテンツフォルダ」列を空欄にする
2. アプリで設定を再選択
3. 従来通りSpreadsheetの親フォルダにアップロードされる

**手動入力を使用:**
1. アプリの設定画面で「手動入力」を選択
2. Spreadsheet IDのみを入力
3. コンテンツフォルダIDなしで動作

### 恒久的な解決策

1. **アクセス可能なフォルダを用意**
   - 個人のGoogleドライブに新しいフォルダを作成
   - または、既存のアクセス可能なフォルダを使用

2. **マスタースプレッドシートを更新**
   - 新しいフォルダIDを設定
   - 名前と備考も分かりやすく記入

3. **アプリで設定を再選択**
   - 設定画面から「登録済み設定から選択」
   - 更新した設定を選択

## よくある質問

### Q: テキストデータはアップロードされますか？

**A:** はい、コンテンツフォルダにアクセスできない場合でも、テキストデータ（登録日時、テキストコンテンツ、緯度・経度など）は正常にアップロードされます。メディアファイルのみがスキップされます。

### Q: Spreadsheetの親フォルダにもアクセスできない場合は？

**A:** その場合は「コンテンツフォルダID」を設定することで、別のアクセス可能なフォルダにメディアファイルをアップロードできます。これが本機能の主な用途です。

### Q: コンテンツフォルダIDを後から変更できますか？

**A:** はい、いつでも変更できます。マスタースプレッドシートを更新して、アプリで設定を再選択してください。

### Q: 複数のプロジェクトで異なるフォルダを使えますか？

**A:** はい、マスタースプレッドシートに複数の設定を登録し、それぞれ異なるコンテンツフォルダIDを設定できます。プロジェクトごとに設定を切り替えてください。

## 関連ドキュメント

- `CONTENT_FOLDER_FEATURE.md` - コンテンツフォルダID機能の詳細
- `WORKSPACE_SPREADSHEET_GUIDE.md` - 組織のワークスペーストラブルシューティング
- `DRIVE_API_SETUP.md` - Drive API初期設定
- `CLAUDE.md` - プロジェクト全体の概要

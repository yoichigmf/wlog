# 組織のワークスペースにあるSpreadsheetへのアクセス設定ガイド

組織のGoogle Workspaceにあるスプレッドシートにアプリからアクセスする場合の設定手順です。

## 問題の概要

エラー: `File not found: [Spreadsheet ID]`

これは、以下のいずれかが原因です：
1. スプレッドシートがサインインしているGoogleアカウントに共有されていない
2. アカウントに編集権限がない
3. 組織のセキュリティポリシーで外部アプリからのアクセスが制限されている

## 対処方法

### ステップ1: スプレッドシートの共有設定を確認

1. **スプレッドシートを開く**
   - Googleスプレッドシートをブラウザで開く
   - URL例: `https://docs.google.com/spreadsheets/d/1kB8iSYABjGWh0FNbOzoN1iiqt_0-TMslrbbU_nyAjyQ/edit`

2. **現在の共有設定を確認**
   - 右上の「共有」ボタンをクリック
   - アプリで使用しているGoogleアカウント（例: `yoichi.kayama@gmail.com`）が含まれているか確認

3. **アカウントを追加（含まれていない場合）**
   - 「ユーザーやグループを追加」に `yoichi.kayama@gmail.com` を入力
   - 権限を **「編集者」** に設定（重要！）
   - 「送信」をクリック

4. **確認**
   - 共有設定に追加したアカウントが表示されることを確認
   - 権限が「編集者」になっていることを確認

### ステップ2: 組織の外部共有設定を確認（組織管理者向け）

組織のGoogle Workspaceで外部アカウントへの共有が制限されている場合があります。

**組織管理者に確認すべき点:**

1. **外部共有が許可されているか**
   - Google Workspace管理コンソール → アプリ → Google Workspace → ドライブとドキュメント
   - 「共有設定」→「外部共有」が許可されているか

2. **APIアクセスが許可されているか**
   - Google Workspace管理コンソール → セキュリティ → API権限
   - 「信頼できるアプリへのアクセス」が有効になっているか

### ステップ3: アプリで使用しているアカウントを確認

1. **アプリでサインインしているアカウントを確認**
   - アプリの「設定」画面を開く
   - サインインしているGoogleアカウントを確認

2. **必要に応じて再サインイン**
   - サインアウトして、スプレッドシートにアクセス権があるアカウントで再サインイン

### ステップ4: スコープの確認

アプリが正しいスコープでアクセスしているか確認します。

**必要なスコープ:**
- `https://www.googleapis.com/auth/spreadsheets` - Google Sheets API
- `https://www.googleapis.com/auth/drive` - Google Drive API

これらのスコープは既にアプリに設定されています。

### ステップ5: テスト

1. **アプリのキャッシュをクリア**
   ```bash
   flutter clean
   adb uninstall com.example.flog
   flutter run
   ```

2. **再度サインイン**
   - アプリで Google Sign-In を実行
   - 権限の許可画面で「許可」を選択

3. **アップロードをテスト**
   - ログを作成
   - 「アップロード」ボタンをタップ

## よくある問題と対処法

### 問題1: 「yoichi.kayama@gmail.com はゲスト」

**状況**: 組織のワークスペースにゲストとして参加している

**対処**:
- ゲストアカウントでも、スプレッドシートが明示的に共有されていれば問題なくアクセスできます
- スプレッドシートの共有設定で、ゲストアカウントに「編集者」権限を付与してください

### 問題2: 「閲覧のみ」権限しかない

**エラー**: 読み取りは成功するが、書き込み時にエラー

**対処**:
- スプレッドシートの共有設定で権限を「編集者」に変更
- 「閲覧者」や「コメント可」では書き込みができません

### 問題3: 組織のポリシーで外部アプリが制限されている

**エラー**: 認証は成功するが、スプレッドシートへのアクセスが拒否される

**対処**:
1. **組織管理者に連絡**
   - Google Workspace管理コンソールで外部アプリのアクセスを許可してもらう
   - または、特定のOAuth 2.0クライアントIDを許可リストに追加してもらう

2. **個人のGoogleアカウントでテスト**
   - 組織のポリシーの影響を受けない個人アカウントでテスト
   - 問題が解決すれば、組織のポリシーが原因と特定できる

### 問題4: Spreadsheet IDが間違っている

**確認方法**:

スプレッドシートのURLから正しいIDを取得：
```
https://docs.google.com/spreadsheets/d/[Spreadsheet ID]/edit
```

例:
```
https://docs.google.com/spreadsheets/d/1kB8iSYABjGWh0FNbOzoN1iiqt_0-TMslrbbU_nyAjyQ/edit
                                    ↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑
                                    この部分がSpreadsheet ID
```

**対処**:
- アプリの設定画面で正しいSpreadsheet IDを入力
- コピー時にスペースや改行が入っていないか確認

## デバッグ方法

### 詳細なログを確認

```bash
flutter run --verbose
```

ログに以下の情報が表示されます：
- `Spreadsheet取得中: [Spreadsheet ID]`
- `認証ユーザー: [メールアドレス]`

これらを確認して、正しいアカウントで正しいSpreadsheetにアクセスしようとしているか確認してください。

### ブラウザでアクセステスト

1. アプリと同じGoogleアカウントでブラウザにサインイン
2. スプレッドシートのURLを開く
3. 編集できるか確認

ブラウザでアクセスできない場合は、共有設定の問題です。

## チェックリスト

アップロードエラーが発生した場合、以下を確認してください：

- [ ] スプレッドシートのURLが正しいか
- [ ] Spreadsheet IDが正しく設定されているか
- [ ] アプリで使用しているGoogleアカウントが確認できるか
- [ ] そのアカウントでスプレッドシートにブラウザからアクセスできるか
- [ ] スプレッドシートの共有設定にアカウントが含まれているか
- [ ] 権限が「編集者」になっているか
- [ ] 組織のセキュリティポリシーで外部アプリが許可されているか
- [ ] アプリで Google Sign-In が成功しているか
- [ ] Google Sheets API と Google Drive API が有効になっているか

## 推奨される設定

### 個人用途の場合

1. **個人のGoogleアカウントを使用**
   - 組織のポリシーの影響を受けない
   - シンプルな設定で動作

2. **スプレッドシートを個人アカウントで作成**
   - より柔軟な共有設定が可能

### 組織で使用する場合

1. **組織管理者と相談**
   - 外部アプリのアクセスポリシーを確認
   - 必要に応じてOAuth 2.0クライアントIDを許可リストに追加

2. **サービスアカウントの使用を検討**（上級者向け）
   - 個人アカウントに依存しない
   - より安定した運用が可能

## 参考情報

- [Google Workspace管理者ヘルプ - ドライブの共有設定](https://support.google.com/a/answer/60781)
- [Google Sheets API - スプレッドシートの共有](https://developers.google.com/sheets/api/guides/sharing)
- [OAuth 2.0 スコープ](https://developers.google.com/identity/protocols/oauth2/scopes)
